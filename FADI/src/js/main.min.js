/**
 * FADI Theme - الـ JavaScript الرئيسي
 * @version 1.0
 */

(function($) {
    'use strict';

    // متغيرات عامة
    const FADI = {
        init: function() {
            this.bindEvents();
            this.initComponents();
            this.loadDashboardFeatures();
            this.initSecurityFeatures();
        },

        bindEvents: function() {
            $(document).ready(this.onDocumentReady.bind(this));
            $(window).on('load', this.onWindowLoad.bind(this));
            $(window).on('resize', this.onWindowResize.bind(this));
        },

        onDocumentReady: function() {
            this.initLoginForm();
            this.initDashboardCards();
            this.initQuickActions();
            this.initNotifications();
        },

        onWindowLoad: function() {
            this.optimizePerformance();
            this.initLazyLoading();
        },

        onWindowResize: function() {
            this.handleResponsiveLayout();
        },

        // تهيئة نموذج تسجيل الدخول
        initLoginForm: function() {
            const $loginForm = $('.login-form form');
            
            if ($loginForm.length) {
                $loginForm.on('submit', function(e) {
                    const $form = $(this);
                    const $submitBtn = $form.find('button[type="submit"]');
                    const originalText = $submitBtn.text();

                    // إضافة مؤشر التحميل
                    $submitBtn.prop('disabled', true)
                              .html('<span class="loading"></span> جاري تسجيل الدخول...');

                    // التحقق من صحة البيانات
                    const username = $form.find('input[name="username"]').val().trim();
                    const password = $form.find('input[name="password"]').val();

                    if (!username || !password) {
                        e.preventDefault();
                        FADI.showNotification('يرجى إدخال اسم المستخدم وكلمة المرور', 'error');
                        $submitBtn.prop('disabled', false).text(originalText);
                        return false;
                    }

                    // إعادة تعيين النص بعد تأخير إذا لم يتم إعادة التوجيه
                    setTimeout(function() {
                        $submitBtn.prop('disabled', false).text(originalText);
                    }, 5000);
                });

                // تحسين تجربة المستخدم
                $loginForm.find('input').on('keypress', function(e) {
                    if (e.which === 13) { // Enter key
                        $loginForm.submit();
                    }
                });

                // إضافة تأثيرات بصرية
                $loginForm.find('input').on('focus', function() {
                    $(this).parent().addClass('focused');
                }).on('blur', function() {
                    if (!$(this).val()) {
                        $(this).parent().removeClass('focused');
                    }
                });
            }
        },

        // تهيئة بطاقات لوحة التحكم
        initDashboardCards: function() {
            const $cards = $('.dashboard-card');

            $cards.each(function() {
                const $card = $(this);
                
                // تأثير الحركة عند التمرير
                $card.on('mouseenter', function() {
                    $(this).addClass('card-hover');
                }).on('mouseleave', function() {
                    $(this).removeClass('card-hover');
                });

                // إضافة كاونتر متحرك للأرقام
                const $counter = $card.find('.stat-number');
                if ($counter.length) {
                    this.animateCounter($counter);
                }
            });

            // تحميل البيانات بشكل ديناميكي
            this.loadDashboardData();
        },

        // تحريك العدادات
        animateCounter: function($element) {
            const target = parseInt($element.text());
            const duration = 2000;
            const step = target / (duration / 16);
            let current = 0;

            const timer = setInterval(function() {
                current += step;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                $element.text(Math.floor(current));
            }, 16);
        },

        // تحميل بيانات لوحة التحكم
        loadDashboardData: function() {
            if (typeof fadi_ajax === 'undefined') return;

            $.ajax({
                url: fadi_ajax.ajax_url,
                type: 'POST',
                data: {
                    action: 'fadi_get_dashboard_stats',
                    nonce: fadi_ajax.nonce
                },
                success: function(response) {
                    if (response.success) {
                        FADI.updateDashboardStats(response.data);
                    }
                },
                error: function() {
                    console.log('خطأ في تحميل بيانات لوحة التحكم');
                }
            });
        },

        // تحديث إحصائيات لوحة التحكم
        updateDashboardStats: function(stats) {
            $.each(stats, function(key, value) {
                const $element = $('[data-stat="' + key + '"]');
                if ($element.length) {
                    $element.text(value);
                    FADI.animateCounter($element);
                }
            });
        },

        // تهيئة الإجراءات السريعة
        initQuickActions: function() {
            // أزرار الإجراءات السريعة
            $('.quick-action-btn').on('click', function(e) {
                e.preventDefault();
                const action = $(this).data('action');
                FADI.handleQuickAction(action);
            });

            // اختصارات لوحة المفاتيح
            $(document).on('keydown', function(e) {
                // Ctrl + S للحفظ السريع
                if (e.ctrlKey && e.which === 83) {
                    e.preventDefault();
                    FADI.quickSave();
                }
                
                // Ctrl + N لإنشاء جديد
                if (e.ctrlKey && e.which === 78) {
                    e.preventDefault();
                    FADI.quickCreate();
                }
            });
        },

        // معالجة الإجراءات السريعة
        handleQuickAction: function(action) {
            switch(action) {
                case 'new_quote':
                    this.createNewQuote();
                    break;
                case 'backup_data':
                    this.backupData();
                    break;
                case 'export_reports':
                    this.exportReports();
                    break;
                case 'check_updates':
                    this.checkUpdates();
                    break;
                default:
                    console.log('إجراء غير معروف:', action);
            }
        },

        // إنشاء عرض سعر جديد
        createNewQuote: function() {
            this.showModal('new-quote-modal', {
                title: 'إنشاء عرض سعر جديد',
                content: this.getNewQuoteForm(),
                buttons: [
                    {
                        text: 'إنشاء',
                        class: 'btn-primary',
                        action: 'save_new_quote'
                    },
                    {
                        text: 'إلغاء',
                        class: 'btn-secondary',
                        action: 'close_modal'
                    }
                ]
            });
        },

        // الحصول على نموذج عرض سعر جديد
        getNewQuoteForm: function() {
            return `
                <form id="new-quote-form" class="fadi-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quote-client">اسم العميل</label>
                            <input type="text" id="quote-client" name="client_name" required>
                        </div>
                        <div class="form-group">
                            <label for="quote-date">تاريخ العرض</label>
                            <input type="date" id="quote-date" name="quote_date" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="quote-description">وصف العرض</label>
                        <textarea id="quote-description" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>البنود</label>
                        <div id="quote-items">
                            <div class="quote-item">
                                <input type="text" placeholder="اسم البند" name="items[0][name]">
                                <select name="items[0][unit]">
                                    <option value="piece">حبة</option>
                                    <option value="m2">م²</option>
                                    <option value="meter">متر</option>
                                </select>
                                <input type="number" placeholder="الكمية" name="items[0][quantity]" min="1">
                                <input type="number" placeholder="السعر" name="items[0][price]" min="0" step="0.01">
                                <button type="button" class="btn-remove-item">حذف</button>
                            </div>
                        </div>
                        <button type="button" id="add-quote-item" class="btn btn-secondary">إضافة بند جديد</button>
                    </div>
                </form>
            `;
        },

        // تهيئة الإشعارات
        initNotifications: function() {
            // إنشاء حاوي الإشعارات إذا لم يكن موجوداً
            if (!$('#fadi-notifications').length) {
                $('body').append('<div id="fadi-notifications"></div>');
            }

            // فحص الإشعارات الدورية
            this.checkNotifications();
            setInterval(this.checkNotifications.bind(this), 300000); // كل 5 دقائق
        },

        // فحص الإشعارات
        checkNotifications: function() {
            $.ajax({
                url: fadi_ajax.ajax_url,
                type: 'POST',
                data: {
                    action: 'fadi_check_notifications',
                    nonce: fadi_ajax.nonce
                },
                success: function(response) {
                    if (response.success && response.data.length > 0) {
                        response.data.forEach(function(notification) {
                            FADI.showNotification(notification.message, notification.type);
                        });
                    }
                }
            });
        },

        // عرض إشعار
        showNotification: function(message, type = 'info', duration = 5000) {
            const $container = $('#fadi-notifications');
            const $notification = $(`
                <div class="fadi-notification fadi-notification-${type}">
                    <div class="notification-content">
                        <span class="notification-icon">${this.getNotificationIcon(type)}</span>
                        <span class="notification-text">${message}</span>
                        <button class="notification-close">&times;</button>
                    </div>
                </div>
            `);

            $container.append($notification);
            
            // تأثير الظهور
            setTimeout(() => $notification.addClass('show'), 100);

            // إزالة تلقائية
            if (duration > 0) {
                setTimeout(() => this.hideNotification($notification), duration);
            }

            // إزالة عند النقر على زر الإغلاق
            $notification.find('.notification-close').on('click', () => {
                this.hideNotification($notification);
            });
        },

        // إخفاء إشعار
        hideNotification: function($notification) {
            $notification.removeClass('show');
            setTimeout(() => $notification.remove(), 300);
        },

        // الحصول على أيقونة الإشعار
        getNotificationIcon: function(type) {
            const icons = {
                'success': '✅',
                'error': '❌',
                'warning': '⚠️',
                'info': 'ℹ️'
            };
            return icons[type] || icons.info;
        },

        // تهيئة الميزات الأمنية
        initSecurityFeatures: function() {
            // مراقبة عدم النشاط
            this.initIdleTimer();
            
            // حماية ضد النقر المتعدد
            this.preventDoubleClick();
            
            // تشفير البيانات الحساسة
            this.initDataEncryption();
        },

        // مراقب عدم النشاط
        initIdleTimer: function() {
            let idleTime = 0;
            const idleInterval = setInterval(() => {
                idleTime++;
                if (idleTime >= 30) { // 30 دقيقة
                    this.handleIdleTimeout();
                }
            }, 60000); // كل دقيقة

            // إعادة تعيين العداد عند النشاط
            $(document).on('mousemove keypress scroll touchstart', () => {
                idleTime = 0;
            });
        },

        // معالجة انتهاء مهلة عدم النشاط
        handleIdleTimeout: function() {
            this.showNotification(
                'ستنتهي جلستك قريباً بسبب عدم النشاط. انقر في أي مكان للاستمرار.',
                'warning',
                10000
            );
        },

        // منع النقر المتعدد
        preventDoubleClick: function() {
            $('form').on('submit', function() {
                const $submitBtn = $(this).find('button[type="submit"], input[type="submit"]');
                $submitBtn.prop('disabled', true);
                
                setTimeout(() => {
                    $submitBtn.prop('disabled', false);
                }, 3000);
            });
        },

        // تحسين الأداء
        optimizePerformance: function() {
            // تحسين الصور
            this.optimizeImages();
            
            // تحسين الجداول الكبيرة
            this.optimizeTables();
            
            // ضغط البيانات المحلية
            this.compressLocalData();
        },

        // تحسين الصور
        optimizeImages: function() {
            $('img[data-src]').each(function() {
                const $img = $(this);
                if (FADI.isElementInViewport($img[0])) {
                    $img.attr('src', $img.data('src')).removeAttr('data-src');
                }
            });
        },

        // فحص ما إذا كان العنصر مرئياً
        isElementInViewport: function(element) {
            const rect = element.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        },

        // تحسين الجداول
        optimizeTables: function() {
            $('.large-table').each(function() {
                const $table = $(this);
                if ($table.find('tr').length > 100) {
                    FADI.initVirtualScrolling($table);
                }
            });
        },

        // تهيئة التمرير الافتراضي للجداول الكبيرة
        initVirtualScrolling: function($table) {
            // تطبيق التمرير الافتراضي لتحسين الأداء
            const itemHeight = 50;
            const containerHeight = 400;
            const visibleItems = Math.ceil(containerHeight / itemHeight);
            
            $table.wrap('<div class="virtual-scroll-container"></div>');
            // المزيد من كود التمرير الافتراضي...
        },

        // معالجة التخطيط المتجاوب
        handleResponsiveLayout: function() {
            const windowWidth = $(window).width();
            
            if (windowWidth < 768) {
                this.enableMobileLayout();
            } else {
                this.enableDesktopLayout();
            }
        },

        // تفعيل تخطيط الهاتف المحمول
        enableMobileLayout: function() {
            $('.dashboard-grid').addClass('mobile-layout');
            $('.quick-nav-btn').addClass('mobile-nav');
        },

        // تفعيل تخطيط سطح المكتب
        enableDesktopLayout: function() {
            $('.dashboard-grid').removeClass('mobile-layout');
            $('.quick-nav-btn').removeClass('mobile-nav');
        },

        // عرض نافذة منبثقة
        showModal: function(id, options) {
            const modalHtml = `
                <div id="${id}" class="fadi-modal">
                    <div class="modal-overlay"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>${options.title}</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${options.content}
                        </div>
                        <div class="modal-footer">
                            ${this.generateModalButtons(options.buttons)}
                        </div>
                    </div>
                </div>
            `;

            $('body').append(modalHtml);
            $(`#${id}`).fadeIn(300);

            // إغلاق النافذة
            $(`#${id} .modal-close, #${id} .modal-overlay`).on('click', () => {
                this.hideModal(id);
            });
        },

        // إخفاء النافذة المنبثقة
        hideModal: function(id) {
            $(`#${id}`).fadeOut(300, function() {
                $(this).remove();
            });
        },

        // إنشاء أزرار النافذة المنبثقة
        generateModalButtons: function(buttons) {
            if (!buttons) return '';
            
            return buttons.map(button => 
                `<button class="btn ${button.class}" data-action="${button.action}">${button.text}</button>`
            ).join('');
        },

        // تهيئة المكونات المتقدمة
        initComponents: function() {
            this.initDatePickers();
            this.initColorPickers();
            this.initFileUploaders();
            this.initSearchComponents();
        },

        // تهيئة منتقي التاريخ
        initDatePickers: function() {
            $('input[type="date"]').each(function() {
                // إضافة تحسينات للتاريخ العربي
                $(this).on('change', function() {
                    const date = new Date($(this).val());
                    const arabicDate = date.toLocaleDateString('ar-SA');
                    $(this).attr('title', arabicDate);
                });
            });
        },

        // تهيئة منتقي الألوان
        initColorPickers: function() {
            $('input[type="color"]').wrap('<div class="color-picker-wrapper"></div>');
        },

        // تحميل البيانات بشكل تقدمي
        initLazyLoading: function() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        this.loadComponent(entry.target);
                        observer.unobserve(entry.target);
                    }
                });
            });

            $('.lazy-load').each(function() {
                observer.observe(this);
            });
        },

        // تحميل مكون
        loadComponent: function(element) {
            const $element = $(element);
            const componentType = $element.data('component');
            
            switch(componentType) {
                case 'chart':
                    this.loadChart($element);
                    break;
                case 'table':
                    this.loadTable($element);
                    break;
                case 'statistics':
                    this.loadStatistics($element);
                    break;
            }
        },

        // تحميل الرسوم البيانية
        loadChart: function($element) {
            // كود تحميل الرسوم البيانية
            $element.html('<div class="chart-placeholder">جاري تحميل الرسم البياني...</div>');
            
            setTimeout(() => {
                $element.html('<div class="chart-loaded">تم تحميل الرسم البياني بنجاح</div>');
            }, 1000);
        }
    };

    // تهيئة النظام عند تحميل الصفحة
    FADI.init();

    // تصدير للاستخدام العام
    window.FADI = FADI;

})(jQuery);

// وظائف مساعدة خارج النطاق
function fadiQuickSave() {
    if (window.FADI) {
        window.FADI.quickSave();
    }
}

function fadiShowNotification(message, type) {
    if (window.FADI) {
        window.FADI.showNotification(message, type);
    }
}

// معالجة الأخطاء العامة
window.addEventListener('error', function(e) {
    console.error('FADI Error:', e.error);
    if (window.FADI) {
        window.FADI.showNotification('حدث خطأ غير متوقع', 'error');
    }
});

// تحميل البيانات المتقدمة
document.addEventListener('DOMContentLoaded', function() {
    // تحميل إضافي للمكونات المتقدمة
    if (typeof Chart !== 'undefined') {
        // تهيئة المخططات
        initCharts();
    }
    
    if (typeof DataTable !== 'undefined') {
        // تهيئة الجداول المتقدمة
        initDataTables();
    }
});

function initCharts() {
    // تهيئة المخططات البيانية
    console.log('Charts initialized');
}

function initDataTables() {
    // تهيئة الجداول التفاعلية
    $('.data-table').each(function() {
        $(this).DataTable({
            language: {
                url: '/wp-content/themes/fadi/assets/datatables-arabic.json'
            },
            responsive: true,
            pageLength: 25
        });
    });
}